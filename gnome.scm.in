;; guile-gnome        -*- scheme -*-
;; Copyright (C) 2003,2004 Andy Wingo <wingo at pobox dot com>

;; This program is free software; you can redistribute it and/or    
;; modify it under the terms of the GNU General Public License as   
;; published by the Free Software Foundation; either version 2 of   
;; the License, or (at your option) any later version.              
;;                                                                  
;; This program is distributed in the hope that it will be useful,  
;; but WITHOUT ANY WARRANTY; without even the implied warranty of   
;; MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the    
;; GNU General Public License for more details.                     
;;                                                                  
;; You should have received a copy of the GNU General Public License
;; along with this program; if not, contact:
;;
;; Free Software Foundation           Voice:  +1-617-542-5942
;; 59 Temple Place - Suite 330        Fax:    +1-617-542-2652
;; Boston, MA  02111-1307,  USA       gnu@gnu.org

;;; Commentary:
;;
;;API version @API_VERSION@ of guile-gnome. Use this module before using
;;any other guile-gnome modules.
;;
;;; Code:

;; Although resolve-module would create (gnome) if it's not found, guile
;; 1.6 will still search for a lib named libgnome.so before giving up.
;; Avoid this problem by making sure (gnome) is defined.
(define-module (gnome))

(define-module (gnome-@API_VERSION@))

(define (ld-library-path-prepend! path)
  (let ((ld-library-path (getenv "LD_LIBRARY_PATH")))
    (if ld-library-path
        (setenv "LD_LIBRARY_PATH" (format #f "~A:~A"
                                          path ld-library-path))
        (setenv "LD_LIBRARY_PATH" path))))

;; Add path to the load path, preserving any modification that the user
;; already made via environment variables. Necessary so that
;; GUILE_LOAD_PATH munging during build works even after (gnome-0)
;; munges the path itself.
(define (add-to-load-path! path)
  (let ((first-std-path (in-vicinity
                         (assq-ref %guile-build-info 'pkgdatadir)
                         "site")))
    (let lp ((tail %load-path) (head '()))
      (cond
       ((null? tail)
        (set! %load-path (cons path %load-path)))
       ((string=? (car tail) first-std-path)
        (set! %load-path (append (reverse head) (cons path tail))))
       (else
        (lp (cdr tail) (cons (car tail) head)))))))
                 
(define version "@API_VERSION@")

(cond
 ((module-variable (resolve-module '(gnome)) 'gnome-version)
  =>
  (lambda (v)
    (if (not (string=? (variable-ref v) version))
        (error "Loading guile-gnome version ~A, but ~A was already loaded"
               (variable-ref v) version))))

 (@running-uninstalled@ ;; #t if we are uninstalled
  (module-define! (resolve-module '(gnome)) 'gnome-version version)
  #t) ;; we're building guile-gnome, let the build scripts do their hacks

 (else
  (module-define! (resolve-module '(gnome)) 'gnome-version version)

  (let ((guile-gnome-dir "@guilegnomedir@")
        (guile-gnome-lib-dir "@guilegnomelibdir@")
        (libdir "@libdir@"))

    (add-to-load-path! guile-gnome-dir)

    ;; Resolve (gnome gw ...) wrapper links to libguile-gnome-gobject.
    (if (not (member libdir '("/usr/lib" "/usr/local/lib")))
        (ld-library-path-prepend! libdir))
  
    ;; Resolve (gnome gw ...) wrappers.
    (ld-library-path-prepend! guile-gnome-lib-dir))))
